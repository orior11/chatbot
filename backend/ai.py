from openai import OpenAI, RateLimitError
import os
from dotenv import load_dotenv
from pathlib import Path

# --- ×©×œ×‘ 1: ×˜×¢×™× ×ª ×”××©×ª× ×™× ×‘×¦×•×¨×” ×—×›××” ---
# ××¦×™××ª ×”×ª×™×§×™×™×” ×”× ×•×›×—×™×ª (backend)
current_dir = Path(__file__).resolve().parent
# ××¦×™××ª ×”×ª×™×§×™×™×” ×”×¨××©×™×ª (×¤×¨×•×™×™×§×˜)
base_dir = current_dir.parent
env_path = base_dir / ".env"

print(f"ğŸ” AI Module is looking for .env at: {env_path}")

# ×˜×¢×™× ×ª ×”×§×•×‘×¥
if env_path.exists():
    load_dotenv(env_path)
    print("âœ… .env file found.")
else:
    print("âŒ .env file NOT found! Please check file location.")

# ×‘×“×™×§×ª ×”××¤×ª×—
api_key = os.getenv("OPENAI_API_KEY")

# --- ×©×œ×‘ 2: ×™×¦×™×¨×ª ×”×§×œ×™×™× ×˜ ×‘×¦×•×¨×” ×‘×˜×•×—×” ---
client = None
if not api_key:
    print("âŒ ERROR: OPENAI_API_KEY is missing or empty.")
else:
    try:
        client = OpenAI(api_key=api_key)
        print("âœ… OpenAI Client initialized successfully.")
    except Exception as e:
        print(f"âŒ Error initializing OpenAI Client: {e}")

DEFAULT_SYSTEM_PROMPT = """
××ª×” ×¡×•×›×Ÿ ×©×™×¨×•×ª ×•××›×™×¨×•×ª ×—×›×, ×™×“×™×“×•×ª×™ ×•××§×¦×•×¢×™, ×”×“×•×‘×¨ ×¢×‘×¨×™×ª ×©×•×˜×¤×ª.

×”×ª×¤×§×™×“ ×©×œ×š:
- ×œ×¡×¤×§ ×©×™×¨×•×ª ×œ×§×•×—×•×ª ××¦×•×™×Ÿ ×‘× ×•×’×¢ ×œ××©×œ×•×—×™× (×¡×˜×˜×•×¡ ×—×‘×™×œ×”, ×–×× ×™ ×”×’×¢×”, ×¢×™×›×•×‘×™×, ×©××œ×•×ª ×›×œ×œ×™×•×ª).
- ×œ×¢×•×“×“ ×‘×¢×“×™× ×•×ª ×”×–×× ×•×ª × ×•×¡×¤×•×ª ×©×œ ××©×œ×•×—×™×, ××‘×œ×™ ×œ×”×™×•×ª ××’×¨×¡×™×‘×™.
- ×œ×©××•×¨ ×¢×œ ×˜×•×Ÿ ×× ×•×©×™, × ×¢×™× ×•×‘×˜×•×—.

×›×œ×œ×™ ×©×™×—×”:
- ×“×‘×¨ ×ª××™×“ ×‘×¢×‘×¨×™×ª ×ª×§× ×™×ª, ×§×œ×™×œ×” ×•×™×“×™×“×•×ª×™×ª.
- ×¤× ×” ×œ×œ×§×•×— ×‘×’×•×£ ×©× ×™ ("××ª×”" / "××ª").
- ×©××•×¨ ×¢×œ ×ª×©×•×‘×•×ª ×§×¦×¨×•×ª ×•×‘×¨×•×¨×•×ª (2â€“4 ××©×¤×˜×™×).
- ×× ×—×¡×¨ ××™×“×¢ (××¡×¤×¨ ×”×–×× ×” / ×˜×œ×¤×•×Ÿ / ×©×) â€“ ×‘×§×© ××•×ª×• ×‘×¦×•×¨×” ×× ×•××¡×ª.
- ×œ×¢×•×œ× ××œ ×ª××¦×™× ××™×“×¢ ×¢×œ ×”×–×× ×”. ×× ××™×Ÿ × ×ª×•× ×™× â€“ ×¦×™×™×Ÿ ×–××ª ×‘×¦×•×¨×” ×‘×¨×•×¨×”.

×©×™×¨×•×ª ×œ×§×•×—×•×ª:
- ×× ×”×œ×§×•×— ×©×•××œ ×¢×œ ×¡×˜×˜×•×¡ ××©×œ×•×—:
  â€¢ ×‘×§×© ××¡×¤×¨ ×”×–×× ×” ××• ××¡×¤×¨ ×˜×œ×¤×•×Ÿ
  â€¢ ××©×¨ ×©×§×™×‘×œ×ª ××ª ×”×¤×¨×˜×™×
  â€¢ ×”×¡×‘×¨ ××” ××¦×‘ ×”××©×œ×•×— ×•××” ×”×¦×¤×™
- ×× ×™×© ×¢×™×›×•×‘:
  â€¢ ×”×ª× ×¦×œ ×‘×§×¦×¨×”
  â€¢ ×ª×Ÿ ×”×¡×‘×¨ ×¨×’×•×¢
  â€¢ ×”×¦×¢ ×¤×ª×¨×•×Ÿ ××• ×¢×“×›×•×Ÿ ×‘×”××©×š

××›×™×¨×•×ª:
- ×œ××—×¨ ××¢× ×” ×©×™×¨×•×ª×™, × ×¡×” ×œ×”×¦×™×¢ ×‘×¢×“×™× ×•×ª ×”×–×× ×” × ×•×¡×¤×ª:
  â€¢ "×¨×•×¦×” ×©××¢×–×•×¨ ×œ×š ×œ×”×–××™×Ÿ ××©×œ×•×— × ×•×¡×£?"
  â€¢ "×™×© ×œ× ×• ×”×¨×‘×” ×œ×§×•×—×•×ª ×©××–××™× ×™× ××¨××© ×›×“×™ ×œ×—×¡×•×š ×–××Ÿ."
- ×× ×”×œ×§×•×— ×œ× ××¢×•× ×™×™×Ÿ â€“ ×›×‘×“ ×–××ª ××™×“.

××¡×•×¨:
- ×œ× ×œ×”×™×•×ª ××’×¨×¡×™×‘×™ ××• ×œ×•×—×¥
- ×œ× ×œ×”×©×ª××© ×‘××™××•×’'×™×
- ×œ× ×œ×“×‘×¨ ×‘×× ×’×œ×™×ª
- ×œ× ×œ×”×‘×˜×™×— ×”×‘×˜×—×•×ª ×©××™× ×Ÿ ×•×“××™×•×ª

×¡×™×•× ×©×™×—×”:
- ×¡×™×™× ×›×œ ×©×™×—×” ×‘×”×¦×¢×” ×œ×¢×–×¨×” × ×•×¡×¤×ª:
  "×™×© ×¢×•×“ ××©×”×• ×©××•×›×œ ×œ×¢×–×•×¨ ×‘×•?"
"""

SUPPORTED_MODELS = {
    "gpt-4o-mini",
    "gpt-4",
    "gpt-3.5-turbo"
}

def chat(
    messages: list[dict],
    model: str = "gpt-4o-mini",
    system_prompt: str | None = None
) -> str:
    
    # ×”×’× ×”: ×× ×”×§×œ×™×™× ×˜ ×œ× ×”×¦×œ×™×— ×œ×”×™×˜×¢×Ÿ, ××œ ×ª×§×¨×•×¡ - ×ª×—×–×™×¨ ×©×’×™××” ×™×¤×”
    if not client:
        return "×©×’×™××ª ××¢×¨×›×ª: ×—×™×‘×•×¨ ×œ-OpenAI × ×›×©×œ (×—×¡×¨ ××¤×ª×— API)."

    if model not in SUPPORTED_MODELS:
        model = "gpt-4o-mini"

    system_prompt = system_prompt or DEFAULT_SYSTEM_PROMPT

    try:
        response = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": system_prompt},
                *messages
            ],
            temperature=0.5,
        )
        return response.choices[0].message.content

    except RateLimitError:
        return (
            "××¦×˜×¢×¨, ×›×¨×’×¢ ×™×© ×¢×•××¡ ×¢×œ ×”××¢×¨×›×ª. "
            "×× × × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×›××” ×“×§×•×ª ××• ×”×©××¨ ×¤×¨×˜×™× ×•× ×—×–×•×¨ ××œ×™×š."
        )

    except Exception as e:
        print(f"OpenAI Runtime Error: {e}")
        return "××™×¨×¢×” ×©×’×™××” ×–×× ×™×ª ×‘×—×™×‘×•×¨ ×œ××•×— ×”×‘×•×˜. ×× × × ×¡×” ×©×•×‘."